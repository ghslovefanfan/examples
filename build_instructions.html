<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <title>Codec Engine Example Build Instructions</title>
<!-- For now, we use the doxygen style sheet -->
  <link type="text/css" rel="stylesheet" href="../docs/html/doxygen.css">
</head>
<body>
<table width="100%">
  <tbody>
    <tr>
      <td bgcolor="black" width="1">
        <a href="http://www.ti.com">
          <img src="../docs/html/tilogo.gif" border="0" alt="Texas
	  Instruments">
        </a>
      </td>
      <td bgcolor="red">
        <img src="../docs/html/titagline.gif" alt="Technology for
	Innovators">
      </td>
    </tr>
  </tbody>
</table>
<h1>Build/Run Instructions for Codec Engine Examples</h1>
<hr>
<h2>General Information</h2>
<p>This page explains how to build the examples provided in the
Codec Engine (CE) product.
</p>
<p>Examples currently contain the simple pass-through (copy) codecs,
implemented in the xDM algorithm standard.
</p>
<hr>
<h2>Requirements</h2>
<p>See the release notes for the specific software and hardware components this
release of Codec Engine has been validated against.
</p>
<hr>
<h2>Directory Structure</h2>
<p>This section describes the layout under the examples directory.  In
most cases, these examples are XDC packages, and there are links to
the autogenerated XDC documentation.  In some cases, the
examples are not proper XDC packages, and documentation is provided
in other means (see the specific example's directory).
</p>
<pre>
examples
    +---apps
    |   +---system_files        <span style="color: rgb(0, 164, 0);">Linux kernel modules (.ko) and scripts that load them for different platforms</span>
    |   |   `---davinci
    |   |       +---DM6446
    |   |       `---DM6467
    |   `---sanity_test         <span style="color: rgb(0, 164, 0);">Sanity test -- pre-built "video_copy" application with sample input file   </span>
    |       +---evmDM6446           <span style="color: rgb(128, 128, 128);">Arm client application and DSP server image with video_copy codecs for EVMDM6446</span>
    |       +---evmDM6467           <span style="color: rgb(128, 128, 128);">Arm client application and DSP server image with video_copy codecs for EVMDM6467</span>
    |       +---evmDM355            <span style="color: rgb(128, 128, 128);">Arm-only application with built-in video_copy codecs for EVMDM355</span>
    |       `---evmDM6437           <span style="color: rgb(128, 128, 128);">DSP-only application with built-in video_copy codecs for EVMDM6437</span>
    `---ti
        `---sdo
            `---ce
                `---examples    <span style="color: rgb(0, 164, 0);">Buildable example codecs, DSP servers, and ARM and/or DSP apps</span>
                    +---codecs
                    |   +---<a href="../xdoc/index.html#ti/sdo/ce/examples/codecs/auddec1_copy/package.html">auddec1_copy</a>
                    |   +---<a href="../xdoc/index.html#ti/sdo/ce/examples/codecs/auddec_copy/package.html">auddec_copy</a>
                    |   +---<a href="../xdoc/index.html#ti/sdo/ce/examples/codecs/audenc1_copy/package.html">audenc1_copy</a>
                    |   +---<a href="../xdoc/index.html#ti/sdo/ce/examples/codecs/audenc_copy/package.html">audenc_copy</a>
                    |   +---<a href="../xdoc/index.html#ti/sdo/ce/examples/codecs/g711/package.html">g711</a>
                    |   +---<a href="../xdoc/index.html#ti/sdo/ce/examples/codecs/imgdec1_copy/package.html">imgdec1_copy</a>
                    |   +---<a href="../xdoc/index.html#ti/sdo/ce/examples/codecs/imgdec_copy/package.html">imgdec_copy</a>
                    |   +---<a href="../xdoc/index.html#ti/sdo/ce/examples/codecs/imgenc1_copy/package.html">imgenc1_copy</a>
                    |   +---<a href="../xdoc/index.html#ti/sdo/ce/examples/codecs/imgenc_copy/package.html">imgenc_copy</a>
                    |   +---<a href="../xdoc/index.html#ti/sdo/ce/examples/codecs/scale/package.html">scale</a>
                    |   +---<a href="../xdoc/index.html#ti/sdo/ce/examples/codecs/sphdec1_copy/package.html">sphdec1_copy</a>
                    |   +---<a href="../xdoc/index.html#ti/sdo/ce/examples/codecs/sphdec_copy/package.html">sphdec_copy</a>
                    |   +---<a href="../xdoc/index.html#ti/sdo/ce/examples/codecs/sphenc1_copy/package.html">sphenc1_copy</a>
                    |   +---<a href="../xdoc/index.html#ti/sdo/ce/examples/codecs/sphenc_copy/package.html">sphenc_copy</a>
                    |   +---<a href="../xdoc/index.html#ti/sdo/ce/examples/codecs/viddec1_copy/package.html">viddec1_copy</a>
                    |   +---<a href="../xdoc/index.html#ti/sdo/ce/examples/codecs/viddec2_copy/package.html">viddec2_copy</a>
                    |   +---<a href="../xdoc/index.html#ti/sdo/ce/examples/codecs/viddec_copy/package.html">viddec_copy</a>
                    |   +---<a href="../xdoc/index.html#ti/sdo/ce/examples/codecs/videnc1_copy/package.html">videnc1_copy</a>
                    |   +---<a href="../xdoc/index.html#ti/sdo/ce/examples/codecs/videnc_copy/package.html">videnc_copy</a>
                    |   `---<a href="../xdoc/index.html#ti/sdo/ce/examples/codecs/vidtranscode_copy/package.html">vidtranscode_copy</a>
                    |
                    +---extensions
                    |   `---<a href="../xdoc/index.html#ti/sdo/ce/examples/extensions/scale/package.html">scale</a>
                    |
                    +---servers
                    |   +---<a href="../xdoc/index.html#ti/sdo/ce/examples/servers/all_codecs/package.html">all_codecs</a>
                    |   `---<a href="../xdoc/index.html#ti/sdo/ce/examples/servers/video_copy/package.html">video_copy</a>
                    |
                    `---apps
                        +---audio1_copy
			|   +---<a href="../xdoc/index.html#ti/sdo/ce/examples/apps/audio1_copy/sync/package.html">sync</a>
                        |   `---async
                        +---audio_copy
                        |   +---dualcpu
                        |   `---<a href="../xdoc/index.html#ti/sdo/ce/examples/apps/audio_copy/singlecpu/package.html">singlecpu</a>
                        +---<a href="../xdoc/index.html#ti/sdo/ce/examples/apps/image1_copy/package.html">image1_copy</a>
                        +---<a href="../xdoc/index.html#ti/sdo/ce/examples/apps/image_copy/package.html">image_copy</a>
                        +---<a href="../xdoc/index.html#ti/sdo/ce/examples/apps/scale/package.html">scale</a>
                        +---speech
                        |   +---<a href="../xdoc/index.html#ti/sdo/ce/examples/apps/speech/dsponly/package.html">dsponly</a>
                        |   `---linuxonly
                        +---<a href="../xdoc/index.html#ti/sdo/ce/examples/apps/speech1_copy/package.html">speech1_copy</a>
                        +---<a href="../xdoc/index.html#ti/sdo/ce/examples/apps/speech_copy/package.html">speech_copy</a>
                        +---<a href="../xdoc/index.html#ti/sdo/ce/examples/apps/video1_copy/package.html">video1_copy</a>
                        +---<a href="../xdoc/index.html#ti/sdo/ce/examples/apps/video2_copy/package.html">video2_copy</a>
                        +---video_copy
                        |   +---dualcpu
                        |   +---dualcpu-separate_config
                        |   +---dualcpu-separate_config_dll
                        |   `---<a href="../xdoc/index.html#ti/sdo/ce/examples/apps/video_copy/singlecpu/package.html">singlecpu</a>
                        `---<a href="../xdoc/index.html#ti/sdo/ce/examples/apps/vidtranscode/package.html">vidtranscode</a>
</pre>

<hr>
<h2>Running the pre-built video_copy example application on the DM6446 and DM6467 DVEVMs</h2>

<p>We assume you have your DVEVM properly set up, and that you
are able to mount an NFS.
</p>
<p>You must pass the <b><span style="color: rgb(204, 0, 0);">MEM=120M</span></b>
(or less than 120M) parameter to your Linux kernel from your u-boot
prompt, or you must have your Linux kernel configured to use no more
than 120MB of physical memory. Read more in the following sections
about the memory map.
</p>
<p>In an NFS directory visible from the DVEVM board, copy all the
files found in <b>apps/system_files/davinci/</b>. Those files are:
</p>
<ul>
  <li><b>dsplinkk.ko</b>, the pre-configured, pre-built DSP Link driver.</li>
  <li><b>cmemk.ko</b>, a Contiguous Memory allocator that allows
allocation of physically contiguous buffers of arbitrary sizes (even
several MB) on the GPP. The Codec Engine requires buffers to
be <i>usable</i> by the processor on which the codec runs. In the
DM6446 architecture, where the ARM creates remote codecs on the DSP,
the buffers must be physically contiguous; GPP applications can use
CMEM to obtain these physically contiguous buffers.</li>
  <li><b>loadmodules.sh</b>, an example loader for the two kernel
modules above.</li>
</ul>
<p>Copy to the same directory as above the DSP client and GPP
server executables you have built (do it for simplicity; the
executables do not need to be in the same directory where kernel
modules are, but the executables themselves must sit in the same
directory together):<br>
</p>
<ul>
  <li><b>apps/sanity_test/&lt;platform&gt;/video_copy.x64P</b></li>
  <li><b>apps/sanity_test/&lt;platform&gt;/app.out</b></li>
</ul>
<p>Also copy the sample input video file to the same directory:<br>
</p>
<ul>
  <li><b>apps/sanity_test/&lt;platform&gt;/in.dat</b></li>
</ul>

<p>(If you want to run the video_copy example you have built your self, you will find the DSP server image
under examples as <b>ti/sdo/ce/examples/servers/video_copy/&lt;platform&gt;/video_copy.x64P</b>, while the ARM-side
application is at <b>ti/sdo/ce/examples/apps/video_copy/dual_cpu/&lt;platform&gt;/app.out</b>.)
</p>

<p>Boot the EVM, change to the directory where you have copied all
these files, and run<br>
&nbsp;&nbsp;&nbsp; <b>sh ./loadmodules.sh</b>
</p>
<p>This script creates /dev devices for CMEM and DSPLINK if they do not
exist already, and, more importantly, loads both modules with
appropriate information about the memory map. For your reference, here
is the contents of the script:</p>

<div style="margin-left: 40px; font-family: monospace;"><span
style="color: rgb(0, 0, 153);">
# insert cmemk, tell it to occupy physical 120MB-128MB, create<br>
# 20 4K buffers, 10 128K buffers  and two 1MB buffers</span><br>
insmod cmemk.ko phys_start=0x87800000 phys_end=0x88000000 pools=20x4096,10x131072,2x1048576<br>
<br>
<span style="color: rgb(0, 0, 153);">
# insert dsplinkk</span><br>
insmod dsplinkk.ko<br>
<br>
<span style="color: rgb(0, 0, 153);">
# make /dev/dsplink</span><br>
rm -f /dev/dsplink<br>
mknod /dev/dsplink c `awk "\\$2==\"dsplink\" {print \\$1}" /proc/devices` 0<br>
</div>

<p>You can find more information below about the default memory map.
The CMEM module above is instructed to set aside two pools, one
containing 20 4K buffers, the other containing two 1MB buffers. This is
good enough for the video_copy application; your application will
likely need different settings.<br>
</p>
<p>When you run the script, you should see the following output:
</p>
<pre>
    $ ./loadmodules.sh
    cmemk: module license '(c) Texas Instruments' taints kernel.
    cmem initialized 3 pools between 0x87800000 and 0x88000000
    dsplinkk: no version for "struct_module" found: kernel tainted.
     DDR_START 0x8fa00000 DDR_SIZE 0x400000
</pre>
<p>Next, run the client application, which will automatically load the
DSP server image:</p>
<p>&nbsp;&nbsp;&nbsp; <b>./app.out</b><br>
</p>
<p>You will see several output lines:</p>
<pre>
    App-> Application started.
    CEapp-> Allocating contiguous buffer for 'input data' of size 1024...
    CEapp-> Contiguous buffer allocated OK (phys. addr=0x87fff000)
    CEapp-> Allocating contiguous buffer for 'encoded data' of size 1024...
    CEapp-> Contiguous buffer allocated OK (phys. addr=0x87ffe000)
    CEapp-> Allocating contiguous buffer for 'output data' of size 1024...
    CEapp-> Contiguous buffer allocated OK (phys. addr=0x87ffd000)
    App-> Processing frame 0...
    App-> Processing frame 1...
    App-> Processing frame 2...
    App-> Processing frame 3...
    App-> Processing frame 4...
    App-> Finished encoding and decoding 4 frames
    App-> Application finished successfully.
</pre>

<p>
To verify that the application has executed correctly, verify the
newly created <b>out.dat</b> file against the input <b>in.dat</b>
file. They should be identical.</p>


<hr>
<h2>Building the examples: step-by-step instructions</h2>
<h3>1. [Optional] Copy the entire "examples" tree out of the product</h3>
<p>
This step is optional, but recommended if you plan to modify the
samples in any way. It will ensure you have a backup copy of the
original examples, as provided by the Codec Engine product.
</p>
<p><i>Important</i>: throughout the rest of this document, we will use the
following notation:
</p>
<ul>
  <li><tt>&lt;CE_EXAMPLES_INSTALL_DIR&gt;</tt> - absolute path of the
  examples directory or the copy you made,
  e.g. <tt>/usr/work/examples</tt></li>
  <li><tt>&lt;CE_INSTALL_DIR&gt;</tt> - root directory of your Codec Engine
  installation. The original examples are in
  <tt>&lt;CE_INSTALL_DIR&gt;/examples</tt>.</li>
  <li><tt>&lt;BIOS_INSTALL_DIR&gt;</tt> - root directory of your DSP/BIOS
  installation.</li>
  <li><tt>&lt;XDC_INSTALL_DIR&gt;</tt> - root directory of your xdctools
  installation.</li>
  <li><i>directory/file</i> - position of the file relative to the
  examples directory; for examples, <tt>ti/sdo/ce/examples/codecs/makefile</tt> refers to
  <tt>&lt;CE_EXAMPLES_INSTALL_DIR&gt;ti/sdo/ce/examples/codecs/makefile</tt>.</li>
</ul>

<h3>2. Edit top-level build files to customize the build for your
software installation and your hardware</h3>
<p>
At the root of the Examples directory are two build-related files that
all Codec Engine examples include. We edit both of these files to
specify where various software components needed by Codec Engine are
on our system, and to narrow the list of hardware targets we want to
build for (thereby reducing the build time and possibly the scope of
external components needed).
</p>

<h4>2.1 Edit XDC user build configuration file, user.bld</h4>
<p>
File <b>user.bld</b> at the root of the Examples directory informs the
XDC tools (tooling which the Codec Engine uses to build itself,
codecs, servers, etc) where to find compilers and other tools on the
user's system, and also what platforms to build for. Open this file in
a text editor.
</p>
<p>
Locate in the file a build table that lists whether to build the
examples for the ARM, for the DSP, and for native Linux. Each of those
three has a list of supported "targets", i.e. runtime environments,
for example the TI C64+ compiler for the DSP, the Montavista Arm9 and
the ucLinux Arm 9 for the Arm. Those "targets" support several
platforms, for example the Montavista Arm 9 target supports
"evmDM6446", "evmDM355", and other platforms.
</p>
<p>Following the simple instructions in the file's comments, disable
builds that you are not interested in, in order to save time. For
example, you may not be interested in building anything for the DSP;
or, for the Arm, you may be interested in building only for target,
"Montavista Arm 9", and for that target, you will likely be interested
in only one platform, for example "evmDM6446", or "evmDM355".
</p>
<p>
For the targets that you do want to build for, you will specify the
base directories of their respective tool chains, as explained and
exemplified in the comments in the file.
</p>

<h4>2.2 Edit xdcpaths.mak to define the necessary variables</h4>
<p>
The <b>xdcpaths.mak</b>file, also located at the root of
the <tt>examples/</tt> directory, defines where the Codec Engine is
installed, where BIOS is, where the XDC tools are, and where
individual Codec Engine packages are. Open this file in a text editor.
</p>
<p>Follow the instructions in the file to specify the following:
<ul>
   <li>(Optional) List of hardware devices you want to build for
   (DM6446, DM355, etc.). This list is specified in
   the <tt>DEVICES</tt> variable. You will likely be interested in
   only one or two devices, so reduce this list to your minimum to
   shorten the build time and to avoid being asked for the location of
   components you don't need.
   </li>
   <li>(Mandatory) Installation directories for the Codec Engine
   itself, for the XDC tools, and for the DSP/BIOS (if you build for
   the DSP). Those you specify in CE_INSTALL_DIR, XDC_INSTALL_DIR, and
   BIOS_INSTALL_DIR variables, as explained in details in the comments
   in the file you are editing.
   </li>
   <li>(Mandatory, depending on your Codec Engine distribution)
   Installation directories for the "minor" components needed by the
   Codec Engine, such as XDAIS, Framework Components, DSP/BIOS Link,
   and CMEM memory manager. If you have a "full" Codec Engine
   distribution that has a <tt>cetools/</tt> directory at its top, all
   these components will automatically be included. If you don't have
   this distribution, and instead xDAIS, DSP/BIOS Link and others are
   installed in other directories, you will have to specify their
   location.
   </li>
   <li>(Mandatory) Location of the compiler tools for architectures
   you'll be building examples for, specifically Montavista Arm9
   and TI C64x
   </li>
</ul>
</p>

<p>
Each directory contains a GNU <tt>makefile</tt> which enables you to build
the sample in the current directory.  Top-level directories also
contain a <tt>makefile</tt> which steps into subdirectories and builds
all the examples under the parent directory.
<p>FYI, the xdcpaths.mak file is included by the individual makefiles
for all the example codecs, servers, and applications.</p>
<p>Please keep in mind that <b><span style="color: rgb(153, 0, 0);">MOST
BUILD TROUBLES OCCUR WHEN ONE OF THE VARIOUS <tt>*_INSTALL_DIR</tt>
VARIABLES ARE INCORRECT!</span></b>
Make sure there are no extra spaces, that every individual path
(segment separated by the semicolon) is correct, character for
character, and the build process is very likely to go smoothly.
</p>


<h3>3. Build example codecs</h3>
<p>Change directory to <b>ti/sdo/ce/examples/codecs</b> and type</p>
<p>&nbsp;&nbsp;&nbsp; <b>gmake clean<br>
&nbsp;&nbsp;&nbsp; gmake</b></p>

<p>Alternatively, you can change into a specific codec's directory
(e.g. <b>ti/sdo/ce/examples/codecs/viddec_copy</b>), and type</p>
<p>&nbsp;&nbsp;&nbsp; <b>gmake clean<br>
&nbsp;&nbsp;&nbsp; gmake</b></p>


<h3>4. Build example extensions</h3>
<p>Change directory to <b>ti/sdo/ce/examples/extensions</b> and type</p>
<p>&nbsp;&nbsp;&nbsp; <b>gmake clean<br>
&nbsp;&nbsp;&nbsp; gmake</b></p>

<p>Alternatively, you can change into a specific example extension directory
(e.g. <b>ti/sdo/ce/examples/extensions/scale</b>), and type</p>
<p>&nbsp;&nbsp;&nbsp; <b>gmake clean<br>
&nbsp;&nbsp;&nbsp; gmake</b></p>


<h3>5. Build example DSP servers</h3>
<p>Note that this is only necessary for dual processor environments,
like DM6446.</p>
<p>Change directory to <tt>ti/sdo/ce/examples/servers</tt> and type</p>
<p>&nbsp;&nbsp;&nbsp; <b>gmake clean<br>
&nbsp;&nbsp;&nbsp; gmake<br>
</b></p>
<p>Alternatively, you can change into a specific server's directory
(e.g. <tt>ti/sdo/ce/examples/servers/video_copy</tt>), and type</p>
<p>&nbsp;&nbsp;&nbsp; <b>gmake clean<br>
&nbsp;&nbsp;&nbsp; gmake<br>
</b></p>
<p>Note: when developing your own codecs and applications, you will
likely take one of the DSP server sample and modify it to suit your
needs.
These are the source files for this server application that you need to
know about:
</p>
<ul>
  <li>*.cfg:  Configuration script that determines what codecs
should be included in the server, and how some of the components
(e.g. DSKT2 and DMAN3) will be configured.</li>
  <li>*.tcf:  TConf file for the app.  It is set to allow for a
generous heap of 122MB and for 4MB of static code and data.  Be very
careful with changing the memory map.</li>
  <li>main.c: generic main()</li>
  <li>link.cmd: application specific linker command file.</li>
</ul>

<h3>6. Build the GPP applications</h3>
<p>Change directory to <tt>ti/sdo/ce/examples/apps</tt>
(where the makefile is) and type</p>
<p>&nbsp;&nbsp;&nbsp; <b>gmake clean<br>
&nbsp;&nbsp;&nbsp; gmake</b>
</p>

<h3>7. Copy files to the target and run</h3>
<p>For a given application you want to run, you need to copy that application's
executable on the target, and if your application requires a DSP server, you
need to copy that DSP server on the target as well. (You can see which DSP
server -- a DSP binary with .x64P extension -- is required by the application
if you look at the application's .cfg file.) In addition, you should copy the
input data file "in.dat" to the target, keeping the relative position between
the application executable and the in.dat file.</p>

<p>
Also, you must make sure that all the required kernel modules (.ko's) for
your target are loaded (tyically via the loadmodules.sh shell script.)
</p>

<p>
<b>Example 1:</b> Running the audio_copy example on evmDM6446:<br>
The ARM-side of the audio_copy example for evmDM6446 is in directory
<tt>examples/ti/sdo/examples/apps/audio_copy/dual_cpu/evmDM6446</tt>. Copy the
<b>app.out</b> file to the target, along with <b>in.dat</b> -- which is in the
same directory, so on the target both files should be in the same directory, as well.
<br><br>The <b>ceapp.cfg</b> file in that directory lists "all.x64P" as its
DSP server image, so you must copy the <b>all.x64P</b> DSP executable for
evmDM6446 from <tt>examples/ti/sdo/ce/examples/servers</tt> (more precisely
from <tt>examples/ti/sdo/ce/examples/servers/all_codecs/evmDM6446/</tt>) to the
target, in the same directory where the ARM-side executable is.
</p>

<p>
<b>Example 2:</b> Running the video1_copy example on evmDM355:<br>
The evmDM355 only has the ARM, so we don't copy any DSP files on the target.
From the build directory <tt>ti/sdo/ce/examples/apps/video1_copy/</tt> we copy
<b>evmDM355/app_local.x470MV</b> on the target, and the <b>in.dat</b> file
as well, making sure in.dat is one level above the Arm executable on the target
as it is in the build directory.
</p>

<hr>
<h2>Memory map</h2>
For information on the default DM6446 memory map -- as addressed by the kernel module
loading scripts and DSP/BIOS configuration files (.tcf scripts) -- and
instructions on how to change this map, please refer to
<a href="http://wiki.davincidsp.com/index.php?title=Changing_the_DVEVM_memory_map">
http://wiki.davincidsp.com/index.php?title=Changing_the_DVEVM_memory_map</a>


<hr>
<p>Last updated: January 28, 2007
</p>
</body>
</html>
